<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StarProdMarket</title>
<style>
  :root{--accent:#ffd166;--bg1:#0d0d16;--bg2:#1d0036}
  html,body{height:100%;margin:0;font-family:Inter,system-ui; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; overflow-x:hidden;}
  .stars{position:fixed;inset:0;background:url('https://i.imgur.com/w1fZP2L.png') repeat;opacity:0.45;filter:blur(2px);z-index:-3}
  .flying-gifts{position:fixed;inset:0;pointer-events:none;z-index:-2}
  header{padding:22px;text-align:center;font-weight:800;font-size:26px;color:var(--accent);text-shadow:0 6px 30px rgba(0,0,0,0.6)}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:8px}
  .avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;background:#fff;display:inline-block}
  .username{font-weight:700}
  .container{max-width:1100px;margin:20px auto;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}
  .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .card h3{margin:0 0 8px}
  .price{font-weight:800;margin-top:8px}
  .btn{background:var(--accent);color:#071428;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800}
  .cart{position:fixed;right:20px;bottom:20px;width:300px;background:rgba(0,0,0,0.35);padding:12px;border-radius:12px}
  .cart h4{margin:0 0 8px}
  .muted{color:rgba(255,255,255,0.6)}
  .gift-float{position:absolute;width:56px;opacity:0.8;filter:drop-shadow(0 8px 18px rgba(0,0,0,0.5))}
</style>
</head>
<body>
<div class="stars"></div>
<div class="flying-gifts" id="flying-gifts"></div>

<header>StarProdMarket — Маркет подарков</header>
<div class="topbar">
  <div class="avatar" id="avatar"></div>
  <div>
    <div class="username" id="username">Гость</div>
    <div class="muted" id="user-balance">Баланс: 0 ⭐</div>
  </div>
</div>

<div class="container">
  <div style="display:flex;gap:14px;align-items:center;margin-bottom:14px">
    <div id="tg-login"></div>
    <button class="btn" id="refresh-btn">Обновить профиль</button>
    <button class="btn" id="create-gift">Создать подарок</button>
  </div>

  <h2 style="margin-top:6px">Каталог — подарки на продаже</h2>
  <div class="grid" id="market-grid"></div>

  <h2 style="margin-top:20px">Мои подарки</h2>
  <div class="grid" id="my-grid"></div>
</div>

<div class="cart" id="cart">
  <h4>Корзина</h4>
  <div id="cart-items" class="muted">Пусто</div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button class="btn" id="checkout">Оформить</button>
    <button class="btn" id="clear">Очистить</button>
  </div>
</div>

<!-- Telegram Login Widget -->
<script async src="https://telegram.org/js/telegram-widget.js?22"
  data-telegram-login="StarProdMarket"
  data-size="medium"
  data-radius="12"
  data-lang="ru"
  data-auth-url="/auth">
</script>

<script>
function $q(sel){return document.querySelector(sel)}
function ce(tag,attrs={}){const e=document.createElement(tag);Object.assign(e,attrs);return e}

function spawnFloating() {
  const container = document.getElementById('flying-gifts');
  const icons = ['https://i.imgur.com/VhYwY7X.png','https://i.imgur.com/uQpI0K3.png','https://i.imgur.com/WyqTq0E.png'];
  for(let i=0;i<10;i++){
    const img=ce('img',{src:icons[Math.floor(Math.random()*icons.length)], className:'gift-float'});
    img.style.left=(Math.random()*90)+'vw';
    img.style.top=(80+Math.random()*30)+'vh';
    img.style.transform=`translateY(0) rotate(${Math.random()*40}deg)`;
    const dur=10+Math.random()*18;
    img.style.transition=`transform ${dur}s linear`;
    container.appendChild(img);
    setTimeout(()=>img.style.transform=`translateY(-120vh) rotate(${360+Math.random()*400}deg)`,200+Math.random()*1000);
    setInterval(()=>{img.style.transform=`translateY(0) rotate(${Math.random()*40}deg)`; setTimeout(()=>img.style.transform=`translateY(-120vh) rotate(${360+Math.random()*400}deg)`,200+Math.random()*50)}, dur*1000+1500);
  }
}
spawnFloating();

let USER=null;
let CART=[];

const urlParams=new URLSearchParams(window.location.search);
const urlUserId=urlParams.get('userId');

async function apiGet(path, opts={}) {
  const headers = opts.initData?{'x-telegram-initdata':opts.initData}:{};
  const res = await fetch(path,{headers});
  return res.json();
}

async function loadProfile(){
  if(urlUserId){
    const user=await apiGet(`/api/user?userId=${encodeURIComponent(urlUserId)}`);
    applyUser(user);
    return;
  }
  if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData){
    const user=await apiGet('/api/user',{initData:window.Telegram.WebApp.initData});
    applyUser(user);
    return;
  }
  applyUser({id:'guest',username:'Гость',avatar:'',stars:0});
}

function applyUser(user){
  USER=user||{id:'guest',username:'Гость',avatar:'',stars:0};
  $q('#username').textContent=USER.username||'Гость';
  $q('#user-balance').textContent=`Баланс: ${USER.stars||0} ⭐`;
  if(USER.avatar)$q('#avatar').innerHTML=`<img src="${USER.avatar}" style="width:100%;height:100%;object-fit:cover">`;
  else $q('#avatar').textContent=USER.username?USER.username.charAt(0).toUpperCase():'G';
}

async function loadMarket(){
  const gifts=await apiGet('/api/gifts');
  const grid=$q('#market-grid');
  grid.innerHTML='';
  gifts.forEach(g=>{
    const c=ce('div',{className:'card'});
    c.innerHTML=`<h3>${g.name}</h3><div class="muted">${g.description||''}</div><div class="price">${g.stars} ⭐</div>`;
    const btn=ce('button',{className:'btn',innerText:'Купить'});
    btn.addEventListener('click',()=>purchase(g.id));
    c.appendChild(btn);
    grid.appendChild(c);
  });
}

async function loadMyGifts(){
  let gifts;
  if(urlUserId) gifts=await apiGet(`/api/my_gifts?userId=${encodeURIComponent(urlUserId)}`);
  else if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) gifts=await apiGet('/api/my_gifts',{initData:window.Telegram.WebApp.initData});
  else gifts=[];
  const grid=$q('#my-grid');
  grid.innerHTML='';
  gifts.forEach(g=>{
    const c=ce('div',{className:'card'});
    c.innerHTML=`<h3>${g.name}</h3><div class="muted">${g.description||''}</div><div class="price">${g.stars} ⭐</div>`;
    const sellBtn=ce('button',{className:'btn',innerText:g.for_sale?'Снято с продажи':'Выставить на продажу'});
    sellBtn.disabled=!!g.for_sale;
    sellBtn.addEventListener('click',async ()=>{
      await fetch('/api/sell_gift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:g.id,priceStars:g.stars})});
      loadMyGifts(); loadMarket();
    });
    c.appendChild(sellBtn);
    grid.appendChild(c);
  });
}

async function createGiftUI(){
  const n=prompt('Название подарка'); if(!n)return;
  const d=prompt('Описание (опционально)');
  const s=Number(prompt('Цена в звёздах (число)'),1)||1;
  const ownerId=USER?.id||urlUserId||'demo';
  await fetch('/api/create_gift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ownerId,name:n,description:d,stars:s})});
  await loadMyGifts(); alert('Подарок создан');
}

function addToCart(gid,name,stars){CART.push({gid,name,stars}); renderCart();}
function renderCart(){const el=$q('#cart-items'); if(!CART.length){el.textContent='Пусто';return;} el.innerHTML=CART.map(i=>`<div>• ${i.name} — ${i.stars} ⭐</div>`).join('');}

$q('#clear').addEventListener('click',()=>{CART=[];renderCart();});
$q('#checkout').addEventListener('click',async ()=>{
  if(!CART.length)return alert('Корзина пуста');
  if(!USER||!USER.id)return alert('Войдите через Telegram');
  const item=CART[0];
  const resp=await fetch('/api/purchase',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyerId:USER.id,giftId:item.gid})});
  const data=await resp.json();
  if(data.ok){alert('Счёт отправлен в Telegram. Завершите оплату в Telegram.');CART=[];renderCart();}
  else alert('Ошибка: '+(data.error||'unknown'));
});

$q('#refresh-btn').addEventListener('click',async ()=>{await loadProfile(); await loadMyGifts(); await loadMarket();});
$q('#create-gift').addEventListener('click',createGiftUI);

(async function init(){await loadProfile(); await loadMarket(); await loadMyGifts();})();
</script>
</body>
</html>
